<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribución de Documentos</title>
    <link rel="stylesheet" href="styles/styleDistribucion.css">
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <button class="btn-volver" onclick="window.location.href='index.html'">Volver</button>
            <h1>Distribución de Documentos</h1>
            <div class="info-badge">
                <span id="totalSeleccionados">0</span> documentos seleccionados
            </div>
        </div>

        <div class="grid-distribucion">
            <div class="grid-header">Portada</div>
            <div class="grid-header">Título</div>
            <div class="grid-header">Formato</div>
            <div class="grid-header">Ubicación 1</div>
            <div class="grid-header">Ubicación 2</div>
            <div class="grid-header">Ubicación 3</div>
        </div>

        <div id="distribucionContainer" class="grid-content">
            <div class="loading">Cargando...</div>
        </div>

        <div class="footer-actions">
            <button class="btn-limpiar" onclick="limpiarCarrito()">Limpiar selección</button>
            <button class="btn-guardar" onclick="guardarDistribucion()">Guardar cambios</button>
        </div>
    </div>

    <!-- GALERÍA -->
    <div id="galeria" class="galeria-modal" style="display:none;" onclick="cerrarGaleria()">
        <div class="galeria-contenido" onclick="event.stopPropagation()">
            <span class="cerrar-galeria" onclick="cerrarGaleria()">×</span>
            <div id="galeria-imagenes"></div>
            <div class="galeria-nav">
                <button onclick="cambiarFoto(-1)">‹</button>
                <span id="galeria-contador"></span>
                <button onclick="cambiarFoto(1)">›</button>
            </div>
        </div>
    </div>

    <script>
        let carrito = JSON.parse(localStorage.getItem('carritoDistribucion')) || [];
        let ubicacionesOriginales = {};
        let fotoActual = 1;
        let totalFotos = 0;
        let ficharegActual = '';

        window.addEventListener('DOMContentLoaded', cargarDocumentosCarrito);

        async function cargarDocumentosCarrito() {
            if (carrito.length === 0) {
                document.getElementById('distribucionContainer').innerHTML = 
                    '<div class="no-data">No hay documentos seleccionados. <a href="index.html">Volver</a></div>';
                return;
            }
            document.getElementById('totalSeleccionados').textContent = carrito.length;

            try {
                const response = await fetch(`http://localhost:3000/api/ubicaciones?fichas=${carrito.join(',')}`);
                const data = await response.json();
                if (data.success && data.data.length > 0) {
                    mostrarDistribucion(data.data);
                } else {
                    document.getElementById('distribucionContainer').innerHTML = '<div class="no-data">Sin ubicaciones</div>';
                }
            } catch (error) {
                document.getElementById('distribucionContainer').innerHTML = '<div class="error">Error</div>';
            }
        }

        function mostrarDistribucion(ubicaciones) {
            const container = document.getElementById('distribucionContainer');
            container.innerHTML = '';

            const porDocumento = {};
            ubicaciones.forEach(ubic => {
                if (!porDocumento[ubic.fichareg]) {
                    porDocumento[ubic.fichareg] = { info: ubic, ubicaciones: [] };
                }
                porDocumento[ubic.fichareg].ubicaciones.push({
                    ubicacion: ubic.ubicacion,
                    existencia: parseInt(ubic.existencia) || 0
                });
            });

            Object.keys(porDocumento).forEach(fichareg => {
                const doc = porDocumento[fichareg];
                const primera = doc.info;
                const totalFisico = doc.ubicaciones.reduce((s, u) => s + u.existencia, 0);
                const esDigital = parseInt(primera.digital) === 1;
                const esImpreso = parseInt(primera.impresa) === 1 || totalFisico > 0;
                let formato = esImpreso && esDigital ? 'Impreso + Digital' : esImpreso ? 'Impreso' : esDigital ? 'Digital' : 'Sin formato';

                const ubicacionesOrdenadas = doc.ubicaciones.sort((a, b) => a.ubicacion.localeCompare(b.ubicacion));
                const celdas = [];
                for (let i = 0; i < 3; i++) {
                    const ubic = ubicacionesOrdenadas[i];
                    if (ubic) {
                        const ubicId = `${fichareg}-${ubic.ubicacion}`;
                        ubicacionesOriginales[ubicId] = ubic.existencia;
                        const max = Math.max(0, ubic.existencia - 1);
                        const reserva = ubic.existencia > 0 && max === 0;
                        celdas.push(`
                            <div class="ubicacion-cell">
                                <div class="ubicacion-codigo">${ubic.ubicacion}</div>
                                <div class="ubicacion-cantidad">${ubic.existencia}</div>
                                <input type="number" class="input-salida" placeholder="0" min="0" max="${max}" value="0"
                                       data-ubicid="${ubicId}" onchange="actualizarCantidad('${ubicId}', this.value)"
                                       ${ubic.existencia === 0 || reserva ? 'disabled' : ''}>
                                ${reserva ? '<div class="reserva-info">Reserva</div>' : ''}
                            </div>
                        `);
                    } else {
                        celdas.push(`<div class="ubicacion-cell vacia"><div class="sin-ubicacion">Sin ubicación</div></div>`);
                    }
                }

                const item = document.createElement('div');
                item.className = 'grid-item-dist';
                item.innerHTML = `
                    <div class="portada-dist">
                        ${primera.fotos > 0 
                            ? `<img src="/fotos/${fichareg}_1.jpg" alt="Portada" class="foto-mini" 
                                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iMzAiIHk9IjQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wnYy1PC90ZXh0Pjwvc3ZnPg=='"
                                    onclick="abrirGaleria('${fichareg}', ${primera.fotos})">`
                            : 'Documento'
                        }
                    </div>
                    <div class="titulo-dist">
                        <strong>${primera.titulo || 'Sin título'}</strong>
                        <small>${primera.subtitulo || ''}</small>
                        <div class="total-info">Total físico: ${totalFisico} ejemplares</div>
                        <span class="ficha-badge">${fichareg}</span>
                    </div>
                    <div class="formato-dist">${formato}</div>
                    ${celdas.join('')}
                `;
                container.appendChild(item);
            });
        }

        function actualizarCantidad(ubicId, salida) {
            const salidaNum = parseInt(salida) || 0;
            const original = ubicacionesOriginales[ubicId];
            const cantDisplay = document.querySelector(`[data-ubicid="${ubicId}"]`).parentNode.querySelector('.ubicacion-cantidad');
            const input = document.querySelector(`[data-ubicid="${ubicId}"]`);
            const maxPermitido = Math.max(0, original - 1);
            if (salidaNum > maxPermitido) {
                alert(`Máximo ${maxPermitido} ejemplares (reserva)`);
                input.value = maxPermitido;
                return;
            }
            const nueva = original - salidaNum;
            cantDisplay.textContent = nueva;
            cantDisplay.classList.add('actualizado');
            if (nueva === 1) { input.disabled = true; cantDisplay.classList.add('reserva'); }
            else if (nueva === 0) { input.disabled = true; cantDisplay.classList.add('agotado'); }
            setTimeout(() => cantDisplay.classList.remove('actualizado'), 500);
        }

        function limpiarCarrito() {
            if (confirm('¿Limpiar?')) {
                localStorage.removeItem('carritoDistribucion');
                window.location.href = 'index.html';
            }
        }

        function guardarDistribucion() {
            const cambios = [];
            document.querySelectorAll('.input-salida').forEach(input => {
                const salida = parseInt(input.value) || 0;
                if (salida > 0) cambios.push({ ubicId: input.dataset.ubicid, salida });
            });
            if (cambios.length === 0) return alert('Sin cambios');
            alert(`Se guardarán ${cambios.length} movimientos`);
        }

        // GALERÍA
        function abrirGaleria(fichareg, total) {
            ficharegActual = fichareg; totalFotos = total; fotoActual = 1;
            mostrarFoto(); document.getElementById('galeria').style.display = 'flex';
        }
        function mostrarFoto() {
            const cont = document.getElementById('galeria-imagenes');
            const cnt = document.getElementById('galeria-contador');
            cont.innerHTML = `<img src="/fotos/${ficharegActual}_${fotoActual}.jpg" class="foto-grande" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjIwMCIgeT0iMjUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wnYy1PC90ZXh0Pjwvc3ZnPg=='">`;
            cnt.textContent = `${fotoActual} / ${totalFotos}`;
        }
        function cambiarFoto(dir) { fotoActual = ((fotoActual + dir - 1 + totalFotos) % totalFotos) + 1; mostrarFoto(); }
        function cerrarGaleria() { document.getElementById('galeria').style.display = 'none'; }
    </script>
</body>
</html>