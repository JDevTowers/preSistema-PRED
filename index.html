<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio Bibliográfico</title>
    <link rel="stylesheet" href="styles/styleIndex.css">
</head>
<body>
    <div class="container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar en el repositorio...">
            <button class="btn-distribucion" onclick="irADistribucion()">
                Distribución <span id="contadorCarrito" class="contador-badge">0</span>
            </button>
            <button class="btn-nuevo" onclick="window.location.href='agregar.html'">Nuevo</button>
        </div>

        <div class="grid-container">
            <div class="grid-header">Portada</div>
            <div class="grid-header">Título</div>
            <div class="grid-header">Autores</div>
            <div class="grid-header">Impreso</div>
            <div class="grid-header">Categoría</div>
            <div class="grid-header">Acciones</div>
        </div>

        <div id="documentosContainer" class="grid-content">
            <div class="loading">Cargando documentos...</div>
        </div>
    </div>

    <!-- GALERÍA MODAL -->
    <div id="galeria" class="galeria-modal" style="display:none;" onclick="cerrarGaleria()">
        <div class="galeria-contenido" onclick="event.stopPropagation()">
            <span class="cerrar-galeria" onclick="cerrarGaleria()">×</span>
            <div id="galeria-imagenes"></div>
            <div class="galeria-nav">
                <button onclick="cambiarFoto(-1)">‹</button>
                <span id="galeria-contador"></span>
                <button onclick="cambiarFoto(1)">›</button>
            </div>
        </div>
    </div>

    <script>
        let carrito = JSON.parse(localStorage.getItem('carritoDistribucion')) || [];
        let fotoActual = 1;
        let totalFotos = 0;
        let ficharegActual = '';

        window.addEventListener('DOMContentLoaded', cargarDocumentos);
        document.getElementById('searchInput').addEventListener('input', e => filtrarDocumentos(e.target.value.toLowerCase()));

        async function cargarDocumentos() {
            const container = document.getElementById('documentosContainer');
            try {
                const response = await fetch('http://localhost:3000/api/documentos');
                const data = await response.json();
                if (data.success && data.data.length > 0) {
                    mostrarDocumentos(data.data);
                } else {
                    container.innerHTML = '<div class="no-data">No hay documentos disponibles</div>';
                }
            } catch (error) {
                console.error('Error al cargar:', error);
                container.innerHTML = '<div class="error">Error al cargar documentos</div>';
            }
        }

        function mostrarDocumentos(documentos) {
            const container = document.getElementById('documentosContainer');
            container.innerHTML = '';
            
            documentos.forEach(doc => {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.dataset.fichareg = doc.fichareg;
                item.dataset.titulo = (doc.titulo || '').toLowerCase();
                item.dataset.autor = (doc.autor || '').toLowerCase();
                item.dataset.categoria = (doc.tipo || '').toLowerCase();

                const fisica = parseInt(doc.existenciaFisica) || 0;
                const esDigital = parseInt(doc.esDigital) || 0;
                const esImpreso = parseInt(doc.esImpreso) || 0;

                let formato = '';
                if (esImpreso && esDigital) formato = 'Impreso + Digital';
                else if (esImpreso || fisica > 0) formato = 'Impreso';
                else if (esDigital) formato = 'Digital';
                else formato = 'Sin formato';

                const enCarrito = carrito.includes(doc.fichareg);

                item.innerHTML = `
                    <div class="portada">
                        ${doc.fotos > 0 
                            ? `<img src="/fotos/${doc.fichareg}_1.jpg" alt="Portada" class="foto-mini" 
                                    onerror="this.style.display='none'; this.parentNode.querySelector('.sin-imagen').style.display='flex';"
                                    onclick="abrirGaleria('${doc.fichareg}', ${doc.fotos})">`
                            : ''
                        }
                        <div class="sin-imagen" style="display: ${doc.fotos > 0 ? 'none' : 'flex'};">
                            Sin imagen
                        </div>
                    </div>
                    <div class="titulo">
                        <strong>${doc.titulo || 'Sin título'}</strong>
                        <small>${doc.subtitulo || ''}</small>
                    </div>
                    <div class="autores">${doc.autor || 'Sin autor'}</div>
                    <div class="impreso">
                        ${formato}
                        <small>Total físico: ${fisica}</small>
                    </div>
                    <div class="categoria">${doc.tipo || 'Sin categoría'}</div>
                    <div class="acciones">
                        <button class="btn-accion btn-carrito ${enCarrito ? 'activo' : ''}" 
                                onclick="toggleCarrito('${doc.fichareg}', this)">Carrito</button>
                        <button class="btn-accion btn-editar" onclick="editar('${doc.fichareg}')">Editar</button>
                        <button class="btn-accion btn-eliminar" onclick="eliminar('${doc.fichareg}')">Eliminar</button>
                    </div>
                `;
                container.appendChild(item);
            });
            actualizarContador();
        }

        function toggleCarrito(fichareg, btn) {
            const index = carrito.indexOf(fichareg);
            if (index > -1) {
                carrito.splice(index, 1);
                btn.classList.remove('activo');
            } else {
                carrito.push(fichareg);
                btn.classList.add('activo');
            }
            localStorage.setItem('carritoDistribucion', JSON.stringify(carrito));
            actualizarContador();
        }

        function actualizarContador() {
            const badge = document.getElementById('contadorCarrito');
            badge.textContent = carrito.length;
            badge.style.display = carrito.length > 0 ? 'inline-block' : 'none';
        }

        function irADistribucion() {
            if (carrito.length === 0) return alert('Selecciona al menos un documento');
            window.location.href = 'distribucion.html';
        }

        function filtrarDocumentos(busqueda) {
            document.querySelectorAll('.grid-item').forEach(item => {
                const visible = item.dataset.titulo.includes(busqueda) || 
                                item.dataset.autor.includes(busqueda) || 
                                item.dataset.categoria.includes(busqueda);
                item.style.display = visible ? 'grid' : 'none';
            });
        }

        function editar(fichareg) { 
            window.location.href = `editar.html?id=${fichareg}`; 
        }

        function eliminar(fichareg) { 
            if (confirm('¿Eliminar este documento?')) {
                alert('Función en desarrollo');
            }
        }

        // GALERÍA
        function abrirGaleria(fichareg, total) {
            ficharegActual = fichareg;
            totalFotos = total;
            fotoActual = 1;
            mostrarFoto();
            document.getElementById('galeria').style.display = 'flex';
        }

        function mostrarFoto() {
            const contenedor = document.getElementById('galeria-imagenes');
            const contador = document.getElementById('galeria-contador');
            contenedor.innerHTML = `
                <img src="/fotos/${ficharegActual}_${fotoActual}.jpg" class="foto-grande" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjIwMCIgeT0iMjUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wnYy1PC90ZXh0Pjwvc3ZnPg=='">
            `;
            contador.textContent = `${fotoActual} / ${totalFotos}`;
        }

        function cambiarFoto(dir) {
            fotoActual = ((fotoActual + dir - 1 + totalFotos) % totalFotos) + 1;
            mostrarFoto();
        }

        function cerrarGaleria() {
            document.getElementById('galeria').style.display = 'none';
        }
    </script>
</body>
</html>